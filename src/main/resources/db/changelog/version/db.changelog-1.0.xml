<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

  <changeSet id="1.0.1" author="dung.pham">
    <createTable tableName="users">
      <column name="id" type="serial"/>
      <column name="email" type="varchar(255)"/>
      <column name="password" type="varchar(255)"/>
      <column name="status" type="varchar(255)"/>
    </createTable>
    
    <createTable tableName="role">
      <column name="id" type="serial"/>
      <column name="role_code" type="varchar(32)"/>
      <column name="role_name" type="varchar(32)"/>
      <column name="description" type="text"/>
    </createTable>
    
    <createTable tableName="user_roles">
      <column name="user_id" type="integer"/>
      <column name="role_id" type="integer"/>
    </createTable>
    
    <addPrimaryKey tableName="users" columnNames="id"/>
    <addPrimaryKey tableName="role" columnNames="id"/>
    
    <addForeignKeyConstraint baseTableName="user_roles" baseColumnNames="user_id" constraintName="user_roles_user_id_fk"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="user_roles" baseColumnNames="role_id" constraintName="user_roles_role_id_fk"
                             referencedTableName="role"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet id="1.0.2" author="dung.pham">
    <sql>
      insert into role (role_code, role_name, description) values ('user', 'User', '');
      insert into role (role_code, role_name, description) values ('super_admin', 'Super Admin', '');
    </sql>
  </changeSet>

  <changeSet id="1.0.3" author="dung.pham">
    <createTable tableName="verification">
      <column name="id" type="serial"/>
      <column name="user_id" type="integer"/>
      <column name="is_verified" type="boolean" defaultValue="false"/>
      <column name="code" type="varchar(6)"/>
      <column name="verified_at" type="timestamp"/>
      <column name="last_send_at" type="timestamp"/>
      <column name="created_at" type="timestamp"/>
      <column name="updated_at" type="timestamp"/>
    </createTable>

    <addPrimaryKey tableName="verification" columnNames="id"/>

    <addForeignKeyConstraint baseTableName="verification" baseColumnNames="user_id"
                             constraintName="verification_user_id_fk"
                             referencedTableName="users"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet id="1.0.4" author="dung.pham">
    <createTable tableName="organization">
      <column name="id" type="serial"/>
      <column name="name" type="varchar(64)"/>
      <column name="description" type="text"/>
      <column name="scale" type="varchar(16)"/>
      <column name="category" type="varchar(16)"/>
      <column name="scope" type="varchar(16)"/>
    </createTable>

    <addColumn tableName="users">
      <column name="organization_id" type="int"/>
    </addColumn>


    <addPrimaryKey tableName="organization" columnNames="id"/>
    <addForeignKeyConstraint baseTableName="users" baseColumnNames="organization_id"
                             constraintName="users_organization_id_fk"
                             referencedTableName="organization"
                             referencedColumnNames="id"/>

    <createTable tableName="location_tag">
      <column name="id" type="serial"/>
      <column name="province" type="varchar(128)"/>
      <column name="district" type="varchar(128)"/>
      <column name="ward" type="varchar(128)"/>
      <column name="phone" type="varchar(16)"/>
    </createTable>

    <createTable tableName="post_offices">
      <column name="id" type="serial"/>
      <column name="name" type="varchar(64)"/>
      <column name="phone" type="varchar(16)"/>
      <column name="address" type="varchar(128)"/>
      <column name="longitude" type="varchar(32)"/>
      <column name="latitude" type="varchar(32)"/>
      <column name="sponsor" type="varchar(64)"/>
      <column name="code" type="varchar(16)"/>
      <column name="sponsor_phone" type="varchar(16)"/>
      <column name="location_tag_id" type="int"/>
    </createTable>

    <addPrimaryKey tableName="location_tag" columnNames="id"/>
    <addPrimaryKey tableName="post_offices" columnNames="id"/>
    <addForeignKeyConstraint baseTableName="post_offices" baseColumnNames="location_tag_id" constraintName="post_offices_location_tag_id_fk" referencedTableName="post_offices"
                         referencedColumnNames="id"/>

    <createTable tableName="customer">
      <column name="id" type="serial"/>
      <column name="full_name" type="varchar(64)"/>
      <column name="email" type="varchar(64)"/>
      <column name="phone" type="varchar(16)"/>
      <column name="address" type="varchar(128)"/>
      <column name="organization_id" type="int"/>
      <column name="is_deleted" type="boolean" defaultValue="false"/>
      <column name="location_tag_id" type="int"/>
    </createTable>

    <addPrimaryKey tableName="customer" columnNames="id"/>
    <addForeignKeyConstraint baseTableName="customer" baseColumnNames="organization_id"
                             constraintName="customer_organization_id_fk"
                             referencedTableName="organization"
                             referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="customer" baseColumnNames="location_tag_id"
                             constraintName="customer_location_tag_id_fk"
                             referencedTableName="location_tag"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet id="1.0.5" author="dung.pham">
    <dropColumn tableName="location_tag" columnName="phone"/>
  </changeSet>

  <changeSet id="1.0.6" author="dung.pham">
    <dropColumn tableName="post_offices" columnName="location_tag_id"/>
    <addColumn tableName="post_offices">
      <column name="location_tag_id" type="int"/>
    </addColumn>
    <addForeignKeyConstraint baseTableName="post_offices" baseColumnNames="location_tag_id" constraintName="post_offices_location_tag_id_fk" referencedTableName="location_tag"
                             referencedColumnNames="id"/>
  </changeSet>

  <changeSet id="1.0.7" author="dung.pham">
    <addColumn tableName="post_offices">
      <column name="deleted" type="boolean" defaultValue="false"/>
    </addColumn>
  </changeSet>
  <changeSet id="1.0.8" author="dung.pham">
    <createTable tableName="wallet">
      <column name="address" type="text"/>
      <column name="secret" type="text"/>
      <column name="salt_iv" type="text"/>
      <column name="code" type="varchar(64)"/>
      <column name="type" type="varchar(16)"/>
    </createTable>
    <addPrimaryKey tableName="wallet" columnNames="address"/>
  </changeSet>
</databaseChangeLog>